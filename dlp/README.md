# Data Loss Prevention (DLP) API Pipeline

This package contains a tool to run the DLP api on a dataset in BigQuery. The
example commands use the [bazel build
system](http://bazel.build/versions/master/docs/install.html), but can also be
run directly (i.e.`python dlp/xxx.py`) if $PYTHONPATH includes this
package.

## Setup

If you are planning to use this tool on real PHI, ensure your project and
permissions follow HIPPA guidelines.

### Authentication

* Enable the [DLP API](https://console.cloud.google.com/apis/api/dlp.googleapis.com/overview)
* Create a [service account](https://cloud.google.com/storage/docs/authentication#service_accounts)
  for your project, give it access to your input BigQuery tables, and download
  its credentials to a json file.
* Activate the service account and point GOOGLE_APPLICATION_CREDENTIALS to the
  service account credentials.

```shell
gcloud auth activate-service-account --key-file=YOUR_KEYS
export GOOGLE_APPLICATION_CREDENTIALS=YOUR_KEYS
```

### Dependencies

Running the pipeline requires having the Google Python API client and the
Python Apache Beam client installed:

```none
pip install --upgrade apache_beam
pip install --upgrade google-api-python-client
```

## Running the pipeline

The pipeline takes as input a table with 3 columns: patient_id, record_number,
and note. You may also provide a query that generates matching row
(--input_query), but note that this causes the data to be stored in a temporary
table which does not have data locality guarantees.

The output is written to 3 separate tables:

* deid_table holds the deidentified notes from the deidentify call to the DLP
  API.
* findings_table holds the findings of PII identified from calling inspect on
  the DLP API.
* annotated_notes_table holds a version of the original notes where the
  identified PII has been annotated with an XML tag.

Example usage:

```shell
bazel build dlp:run_deid && \
bazel-bin/dlp/run_deid \
  --input_table "${PROJECT?}:${DATASET?}.dlp_input" \
  --project ${PROJECT?} \
  --deid_config_file dlp/sample_deid_config.json \
  --deid_table ${PROJECT?}:${DATASET?}.deid_output \
  --findings_table ${PROJECT?}:${DATASET?}.dlp_findings \
  --annotated_notes_table ${PROJECT?}:${DATASET?}.dlp_annotated
  --mae_dir gs://bucket-name/mae-output-directory
```

## Config file

--deid_config_file specifies a json file (example in [sample_deid_config.json](http://github.com/GoogleCloudPlatform/healthcare-deid/tree/master/dlp/sample_deid_config.json))
that contains an object with two fields:

1. deidConfig: A [DeidentifyConfig](https://cloud.google.com/dlp/docs/reference/rest/v2beta1/content/deidentify#DeidentifyConfig)
for use with the DLP API's content.deidentify method.

2. infoTypeCategories: A list of tags to use in the MAE output and the infoTypes
from the deidConfig that correspond to those tags. Each entry in the list has a
name, and a list of infoTypes, e.g.:

```none
{
  "name": "FIRST_NAME",
  "infoTypes": ["US_FEMALE_NAME", "US_MALE_NAME"]
}
```

## MAE Format

If you specify the --mae_dir flag, the pipeline will write xml files to a GCS
directory. The files will be named using the structure
"`patientid`-`recordnumber`.xml", with a DTD file in "classification.dtd".
Examples are available under [mae_testdata](http://github.com/GoogleCloudPlatform/healthcare-deid/tree/master/dlp/mae_testdata)
in `sample.xml` and `sample.dtd`.

### DTD Format

The DTD format is described at
http://github.com/keighrim/mae-annotation/wiki/defining-dtd. The DTD file
generated by the pipeline uses the name provided in --mae_task_name, and has
one element for each infoType specified in --deid_config_file. e.g.:

```none
<!ELEMENT FIRST_NAME ( #PCDATA ) >
<!ATTLIST FIRST_NAME id ID prefix="FIRST_NAME" #REQUIRED >
```

### XML Format

The top-level tag is the one specified in --mae_task_name. Then comes the text,
wrapped in TEXT and CDATA, e.g.:

```none
<TEXT><![CDATA[the text of the note goes here]]></TEXT>
```

Then we have the tags indicating discovered PID. The tag is the infoType, and
the id is the infoType plus an integer to uniquely identify it, e.g.:

```
<TAGS>
<US_CENSUS_NAME id="US_CENSUS_NAME0" spans="9~12" />
<US_MALE_NAME id="US_MALE_NAME0" spans="9~12" />
<US_CENSUS_NAME id="US_CENSUS_NAME1" spans="17~25" />
</TAGS>
```
